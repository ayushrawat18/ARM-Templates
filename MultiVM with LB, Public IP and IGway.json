{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUsername": {
      "type": "string",
      "defaultValue": "jimmy",
      "metadata": {
        "description": "Admin username"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password"
      }
    },
    "dnsNameforLBIP": {
      "type": "string",
      "defaultValue": "k000lbtest1113",
      "metadata": {
        "description": "Unique DNS name"
      }
    },
    "vmNamePrefix": {
      "type": "string",
      "defaultValue": "k000labVM",
      "metadata": {
        "description": "VM name prefix"
      }
    },
    "lbName": {
      "type": "string",
      "defaultValue": "k000labLB",
      "metadata": {
        "description": "Load Balancer name"
      }
    },
    "vnetName": {
      "type": "string",
      "defaultValue": "k000labVnet",
      "metadata": {
        "description": "VNET name"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D1_v2",
      "metadata": {
        "description": "VM Size"
      }
    },
	"location": {
		"type": "string",
		"defaultValue": "West US",
		"metadata": {
			"description": "Location"
		}
	},    
  	"instanceCount": {
  		"type": "string",
  		"defaultValue": "6"
  	},
    "lbPrefix": {
      "type": "string",
      "defaultValue": "k000lbtest"
    } 	    
  },
  "variables": {
    "storageAccountName": "[concat(uniquestring(resourceGroup().id), 'savms')]",
    "storageAccountType": "Standard_LRS",
    "vmStorageAccountContainerName": "vhds",
    "availabilitySetName": "[concat(parameters('lbPrefix'), 'avset')]",
    "addressPrefix": "10.0.0.0/16",
    "subnetName": "[concat(parameters('lbPrefix'), 'Subnet')]",
    "subnetPrefix": "10.0.0.0/24",
    "publicIPAddressType": "Dynamic",
    "OSDiskName": "[concat(parameters('lbPrefix'), 'osdisk')]",
    "nicName": "[concat(parameters('lbPrefix'), 'NIC')]",
    "instanceCountInt": "[int(parameters('instanceCount'))]",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',parameters('vnetName'))]",
    "subnetRef": "[concat(variables('vnetID'),'/subnets/',variables ('subnetName'))]",
    "publicIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses',concat(parameters('lbName'),'IP'))]",
    "lbID": "[resourceId('Microsoft.Network/loadBalancers',parameters('lbName'))]",
    "frontEndIPConfigID": "[concat(variables('lbID'),'/frontendIPConfigurations/loadBalancerFrontend')]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('storageAccountName')]",
      "apiVersion": "2016-01-01",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "[variables('storageAccountType')]"
      },
      "kind": "Storage",
      "properties": {}
    },
    {
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('availabilitySetName')]",
      "apiVersion": "2015-06-15",
      "location": "[parameters('location')]",
      "properties": {}
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[concat(parameters('lbName'),'IP')]",
      "location": "[parameters('location')]",
      "properties": {
        "publicIPAllocationMethod": "[variables('publicIPAddressType')]",
        "dnsSettings": {
          "domainNameLabel": "[parameters('dnsNameforLBIP')]"
        }
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[parameters('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('addressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetName')]",
            "properties": {
              "addressPrefix": "[variables('subnetPrefix')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(variables('nicName'), copyindex())]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "nicLoop",
        "count": "[variables('instanceCountInt')]"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]",
        "[concat('Microsoft.Network/loadBalancers/', parameters('lbName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "[variables('subnetRef')]"
              },
              "loadBalancerBackendAddressPools": [
                {
                  "id": "[concat(variables('lbID'), '/backendAddressPools/LoadBalancerBackend')]"
                }
              ],
              "loadBalancerInboundNatRules": [
                {
                  "id": "[concat(variables('lbID'),'/inboundNatRules/', parameters('vmNamePrefix'), copyindex())]"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "name": "[parameters('lbName')]",
      "type": "Microsoft.Network/loadBalancers",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', parameters('lbName'), 'IP')]"
      ],
      "properties": {
        "frontendIPConfigurations": [
          {
            "name": "LoadBalancerFrontend",
            "properties": {
              "publicIPAddress": {
                "id": "[variables('publicIPAddressID')]"
              }
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "LoadBalancerBackend"
          }
        ],
        "inboundNatRules": [
          {
            "name": "[concat(parameters('vmNamePrefix'), '0')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7000,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '1')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7001,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '2')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7002,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '3')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7003,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '4')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7004,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '5')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7005,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '6')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7006,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '7')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7007,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '8')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7008,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '9')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7009,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '10')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7010,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '11')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7011,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '12')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7012,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '13')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7013,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '14')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7014,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '15')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7015,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '16')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7016,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '17')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7017,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '18')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7018,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '19')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7019,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '20')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7020,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '21')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7021,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '22')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7022,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '23')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7023,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '24')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7024,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '25')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7025,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '26')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7026,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '27')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7027,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '28')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7028,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '29')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7029,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '30')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7030,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '31')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7031,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '32')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7032,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '33')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7033,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '34')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7034,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '35')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7035,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '36')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7036,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '37')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7037,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '38')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7038,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '39')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7039,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '40')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7040,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '41')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7041,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '42')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7042,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '43')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7043,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '44')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7044,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '45')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7045,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '46')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7046,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '47')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7047,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '48')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7048,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '49')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7049,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '50')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7050,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '51')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7051,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '52')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7052,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '53')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7053,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '54')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7054,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '55')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7055,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '56')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7056,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '57')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7057,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '58')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7058,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '59')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7059,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '60')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7060,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '61')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7061,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '62')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7062,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '63')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7063,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '64')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7064,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '65')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7065,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '66')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7066,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '67')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7067,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '68')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7068,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '69')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7069,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '70')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7070,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '71')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7071,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '72')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7072,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '73')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7073,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '74')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7074,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '75')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7075,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '76')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7076,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '77')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7077,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '78')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7078,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '79')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7079,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '80')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7080,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '81')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7081,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '82')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7082,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '83')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7083,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '84')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7084,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '85')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7085,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '86')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7086,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '87')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7087,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '88')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7088,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '89')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7089,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '90')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7090,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '91')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7091,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '92')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7092,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '93')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7093,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '94')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7094,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '95')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7095,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '96')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7096,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '97')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7097,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '98')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7098,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          },
          {
            "name": "[concat(parameters('vmNamePrefix'), '99')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('frontEndIPConfigID')]"
              },
              "protocol": "tcp",
              "frontendPort": 7099,
              "backendPort": 8443,
              "enableFloatingIP": false
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[concat(parameters('vmNamePrefix'), copyindex())]",
      "copy": {
        "name": "virtualMachineLoop",
        "count": "[variables('instanceCountInt')]"
      },
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', concat(variables('nicName'),copyIndex()))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('availabilitySetName'))]"
      ],
      "properties": {
        "availabilitySet": {
          "id": "[resourceId('Microsoft.Compute/availabilitySets',variables('availabilitySetName'))]"
        },
        "hardwareProfile": {
          "vmSize": "[parameters('vmSize')]"
        },
        "osProfile": {
          "computerName": "[concat(parameters('vmNamePrefix'), copyIndex())]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "UbuntuServer",
            "sku": "16.04.0-LTS",
            "version": "latest"
          },         
          "osDisk": {
            "name": "osdisk",
            "osType": "linux",
	        "vhd": {
              "uri": "[concat(reference(concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName')), '2016-01-01').primaryEndpoints.blob, variables('vmStorageAccountContainerName'),'/',variables('OSDiskName'),copyIndex(),'.vhd')]"
            },	
            "caching": "ReadWrite",
            "createOption": "FromImage"     
          }
        },
		"networkProfile": {
			"networkInterfaces": [{
				"id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('nicName'),copyIndex()))]"
			}]
		}
      }
    }
  ]
}